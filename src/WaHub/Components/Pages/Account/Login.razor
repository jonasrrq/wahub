@page "/Account/login"
@* @rendermode InteractiveServer *@
@* @attribute [StreamRendering] *@

@inject LocalizationService Localization

@inject SignInManager<ApplicationUser> singInManager
@inject UserManager<ApplicationUser> userManager
@inject NavigationService Navigation

<PageTitle>@Localization.Login - WaHub</PageTitle>



<div class="login-container">
    <div class="login-form">
        <h1>@Localization.Login</h1>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                @errorMessage
            </div>
        }
        @* <div class="test-credentials">
            <p><strong>Credenciales de prueba:</strong></p>            
            <div class="credentials-buttons">
                <button type="button" class="test-cred-btn" @onclick="FillAdminCredentials">
                    游녬 Admin: admin@wahub.com
                </button>
                <button type="button" class="test-cred-btn" @onclick="FillUserCredentials">
                    游녻 Usuario: user@wahub.com
                </button>
            </div>
        </div> *@

        <EditForm Model="inputModel" method="post" FormName="Refister">

        </EditForm>


        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" @bind="email" placeholder="admin@wahub.com" required />
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" @bind="password" placeholder="admin123" required />
        </div>
        <button type="button" class="login-button" disabled="@isLoading" @onclick="HandleLogin">
            @if (isLoading)
            {
                <div class="login-loading">
                    <div class="login-spinner"></div>
                    <span>Iniciando sesi칩n...</span>
                </div>
            }
            else
            {
                <span>@Localization.Login</span>
            }
        </button>

        <p>쯅o tienes cuenta? <a href="/Account/register">Reg칤strate aqu칤</a></p>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private LoginModel inputModel { get; set; } = new();

    private string email = "";
    private string password = "";
    private bool isLoading = false;
    private string errorMessage = "";

    public class LoginModel
    {
        public string Email { get; set; }
        public string Password { get; set; }
    }

    // Datos de prueba para el login
    // private readonly Dictionary<string, string> testUsers = new()
    // {
    //     { "admin@wahub.com", "admin123" },
    //     { "user@wahub.com", "user123" },
    //     { "demo@wahub.com", "demo123" }
    // };

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Por favor, ingresa tu email y contrase침a.";
            return;
        }

        isLoading = true;
        errorMessage = "";

        try
        {

            var findUser = await userManager.FindByEmailAsync(email);
            if (findUser == null)
            {
                errorMessage = "Credenciales incorrectas. Usa las credenciales de prueba mostradas arriba.";
                return;
            }

            var result = await singInManager.CheckPasswordSignInAsync(findUser, password, false);

            if (!result.Succeeded)
            {
                errorMessage = "Credenciales incorrectas. Usa las credenciales de prueba mostradas arriba.";
                return;
            }

            await singInManager.PasswordSignInAsync(findUser, password, false, false);
            Navigation.Push("/dashboard");

            // // Simular delay de red
            // await Task.Delay(1000);
            // // Validar credenciales de prueba
            // if (testUsers.ContainsKey(email.ToLower()) && testUsers[email.ToLower()] == password)
            // {
            //     // Login exitoso
            //     var userType = email.Contains("admin") ? "admin" : "user";
            //     var token = $"fake-jwt-token-{userType}-{DateTime.Now:yyyyMMddHHmmss}";

            //     await Auth.SetTokenAsync(token);

            //     // Esperar un momento para que se procese el estado de autenticaci칩n
            //     await Task.Delay(100);

            //     // Forzar actualizaci칩n del estado
            //     StateHasChanged();                // Navegar al dashboard
            //     Navigation.Push("/dashboard");
            // }
            // else
            // {
            //     errorMessage = "Credenciales incorrectas. Usa las credenciales de prueba mostradas arriba.";
            // }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error durante el login: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FillTestCredentials(string email, string password)
    {
        this.email = email;
        this.password = password;
        StateHasChanged();
    }

    private void FillAdminCredentials()
    {
        FillTestCredentials("admin@wahub.com", "admin123");
    }

    private void FillUserCredentials()
    {
        FillTestCredentials("user@wahub.com", "user123");
    }
}
